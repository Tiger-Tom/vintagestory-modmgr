name: Package
on: workflow_dispatch

env:
    PYTHON_OPTIMIZE: 2

jobs:
    build-zipapp:
        name: Create ZipApp
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v3
          - uses: actions/setup-python@v4
            with:
                python-version: '3.11'
                cache: pip
          - name: Install requirements
            run: pip install -r requirements.txt
          - name: Create Runner File __main__.py
            uses: DamianReeves/write-file-action@v1.2
            with:
                path: __main__.py
                contents: import main;main.main()
          - name: Add Files to Zips
            run: zip -r -0 vintagestory-modmgr.pyz.zip __main__.py main.py basemod.py modes/ gui/ LICENSE
          - name: Convert Zip to PYZs
            run: python3 -m zipapp -p /usr/bin/python3 vintagestory-modmgr.pyz.zip -o vintagestory-modmgr.pyz
          - name: Test Application
            run: python3 vintagestory-modmgr.pyz --help
          - name: Upload Build Artifact
            uses: actions/upload-artifact@v3
            with:
                name: ZipApp (cross-platform, requires Python to be installed)
                path: vintagestory-modmgr.pyz
    build-executable:
        env:
            bundle_common: 'main.py --onefile'
            bundle_common_sans: '--hidden-import webview --console'
            bundle_common_avec: '--windowed'
            bundle_lin_sans: ''
            bundle_lin_avec: '--add-data ./gui/:gui'
            bundle_win_sans: ''
            bundle_win_avec: '--add-data ./gui/;gui'
            bundle_mac_sans: ''
            bundle_mac_avec: '--add-data ./gui/:gui'
        strategy:
            fail-fast: false
            matrix:
                os:
                  - {name: 'ubuntu-latest',  title: 'Linux',   exec: 'vintagestory-modmgr{0}',     id: 'l',
                        sans_gui: '$bundle_lin_sans',
                        avec_gui: '$bundle_lin_avec'}
                  - {name: 'windows-latest', title: 'Windows', exec: 'vintagestory-modmgr{0}.exe', id: 'w',
                        sans_gui: '$env:bundle_win_sans',
                        avec_gui: '$env:bundle_win_avec'}
                  - {name: 'macos-latest',   title: 'MacOS',   exec: 'vintagestory-modmgr{0}',     id: 'm',
                        sans_gui: '$bundle_mac_sans',
                        avec_gui: '$bundle_mac_avec'}
        name: Build Executable For ${{ matrix.os.title }}
        runs-on: ${{ matrix.os.name }}
        steps:
          - uses: actions/checkout@v3
          - uses: actions/setup-python@v4
            with:
                python-version: '3.11'
            # Install required libraries
          - name: Install UPX
            if: matrix.os.id == 'w'
            uses: crazy-max/ghaction-upx@v2
          - name: Install PyInstaller
            run: pip install -U pyinstaller pyinstaller-hooks-contrib
          - name: Install Requirements
            run: pip install -r requirements.txt
            # Build Sans GUI
          - name: Bundle With PyInstaller (Sans GUI) For ${{ matrix.os.title }}
            run: ${{ (matrix.os.id == 'w') && '&' }} pyinstaller ${{ env.bundle_common }} ${{ env.bundle_common_sans }} ${{ matrix.os.sans_gui }} --name ${{ format(matrix.os.exec, '') }}
            # Install GUI library
          - name: Install PyWebView (GUI)
            run: pip install -U pywebview
            # Build Avec GUI
          - name: Bundle With PyInstaller (Avec GUI) For ${{ matrix.os.title }}
            run: ${{ (matrix.os.id == 'w') && '&' || ''}} pyinstaller ${{ env.bundle_common }} ${{ env.bundle_common_avec }} ${{ matrix.os.avec_gui }} --name ${{ format(matrix.os.exec, '-gui') }} ${{ (matrix.os.id != 'm') && '--splash ./bundle/vintagestory-modmgr_splash.png' || '' }}
            # Upload artifacts
            ## Sans GUI
          - name: Upload ${{ matrix.os.title }} Executable Artifact (Sans GUI)
            uses: actions/upload-artifact@v3
            with:
                name: ${{ matrix.os.title }} Binary (Sans GUI)
                path: dist/${{ format(matrix.os.exec, '') }}
            ## Avec GUI
          - name: Upload ${{ matrix.os.title }} Executable Artifact (Avec GUI)
            uses: actions/upload-artifact@v3
            with:
                name: ${{ matrix.os.title }} Binary (Avec GUI)
                path: dist/${{ format(matrix.os.exec, '-gui') }}
          - name: Upload MacOS App Artifact (Avec GUI)
            if: matrix.os.id == 'm'
            uses: actions/upload-artifact@v3
            with:
                name: MacOS App (Avec GUI)
                path: dist/${{ format(matrix.os.exec, '-gui.app') }}